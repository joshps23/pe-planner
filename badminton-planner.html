<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PE Activity Consultant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 0;
            margin: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
            position: relative;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><g fill="%23ffffff" fill-opacity="0.05"><circle cx="30" cy="30" r="2"/></g></g></svg>');
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            position: relative;
            z-index: 1;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 10px 0 0 0;
            position: relative;
            z-index: 1;
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        .controls {
            width: 320px;
            background: #f8fafc;
            padding: 0;
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
            max-height: 80vh;
        }

        .control-section {
            border-bottom: 1px solid #e2e8f0;
        }
        
        .control-section:last-child {
            border-bottom: none;
        }

        .control-header {
            padding: 20px 25px 15px;
            background: #f1f5f9;
            cursor: pointer;
            user-select: none;
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .control-header:hover {
            background: #e2e8f0;
        }
        
        .control-header h3 {
            color: #334155;
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-header::after {
            content: '⌄';
            font-size: 14px;
            color: #64748b;
            transition: transform 0.2s ease;
        }
        
        .control-section.collapsed .control-header::after {
            transform: rotate(-90deg);
        }
        
        .control-content {
            padding: 20px 25px;
            display: block;
        }
        
        .control-section.collapsed .control-content {
            display: none;
        }

        .control-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        .control-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
        
        .control-btn:active {
            transform: translateY(0);
        }

        .equipment-btn {
            background: #ef4444;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        }

        .equipment-btn:hover {
            background: #dc2626;
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }
        
        .success-btn {
            background: #10b981;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }
        
        .success-btn:hover {
            background: #059669;
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }
        
        .warning-btn {
            background: #f59e0b;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
        }
        
        .warning-btn:hover {
            background: #d97706;
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }
        
        .danger-btn {
            background: #ef4444;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        }
        
        .danger-btn:hover {
            background: #dc2626;
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }
        
        .secondary-btn {
            background: #6b7280;
            box-shadow: 0 2px 4px rgba(107, 114, 128, 0.2);
        }
        
        .secondary-btn:hover {
            background: #4b5563;
            box-shadow: 0 4px 8px rgba(107, 114, 128, 0.3);
        }
        
        .purple-btn {
            background: #8b5cf6;
            box-shadow: 0 2px 4px rgba(139, 92, 246, 0.2);
        }
        
        .purple-btn:hover {
            background: #7c3aed;
            box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
        }

        .court-container {
            flex: 1;
            position: relative;
            background: #16a34a;
            margin: 30px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .playing-area {
            width: 100%;
            height: 600px;
            position: relative;
            background: radial-gradient(ellipse at center, #22c55e 0%, #16a34a 100%);
            background-image: 
                linear-gradient(90deg, rgba(255,255,255,0.1) 0px, rgba(255,255,255,0.1) 1px, transparent 1px, transparent 100%),
                linear-gradient(0deg, rgba(255,255,255,0.1) 0px, rgba(255,255,255,0.1) 1px, transparent 1px, transparent 100%);
            background-size: 30px 30px;
        }

        .badminton-court {
            background: radial-gradient(ellipse at center, #22c55e 0%, #16a34a 100%);
        }

        .basketball-court {
            background: linear-gradient(135deg, #d97706 0%, #c2410c 100%);
        }

        .volleyball-court {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        }

        .soccer-field {
            background: radial-gradient(ellipse at center, #15803d 0%, #14532d 100%);
        }

        .tennis-court {
            background: linear-gradient(135deg, #0369a1 0%, #075985 100%);
        }

        .blank-space {
            background: #ffffff;
            border: 2px solid #e5e7eb;
        }

        .court-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .court-line {
            position: absolute;
            background-color: white;
        }

        .outer-boundary {
            border: 3px solid white;
            width: calc(100% - 40px);
            height: calc(100% - 40px);
            left: 20px;
            top: 20px;
        }

        .center-line {
            width: 2px;
            height: calc(100% - 40px);
            left: 50%;
            top: 20px;
            transform: translateX(-50%);
        }

        .service-lines {
            width: calc(100% - 40px);
            height: 2px;
            left: 20px;
        }

        .front-service-line {
            top: 35%;
        }

        .back-service-line {
            top: 65%;
        }

        .net {
            position: absolute;
            width: calc(100% - 40px);
            height: 6px;
            background: linear-gradient(to bottom, #1f2937, #111827);
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }
        
        .net::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 0;
            right: 0;
            height: 20px;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 4px,
                rgba(31, 41, 55, 0.3) 4px,
                rgba(31, 41, 55, 0.3) 5px
            );
        }

        .draggable-item {
            position: absolute;
            cursor: move;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }

        /* Player visual representation with emojis */
        .student {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            line-height: 1;
        }

        .attacker {
            background-image: url('attacker.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: transparent;
            border-radius: 50%;
            background-blend-mode: multiply;
        }

        .attacker::before {
            content: '';
            display: none;
        }

        .defender {
            background-image: url('defender.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: transparent;
            border-radius: 50%;
            background-blend-mode: multiply;
        }

        .defender::before {
            content: '';
            display: none;
        }

        /* Alternative options for variety */
        .student.alt-style.attacker {
            background-image: url('attacker.png');
            background-color: transparent;
            border-radius: 50%;
            background-blend-mode: multiply;
        }

        .student.alt-style.attacker::before {
            display: none;
        }

        .student.alt-style.defender {
            background-image: url('defender.png');
            background-color: transparent;
            border-radius: 50%;
            background-blend-mode: multiply;
        }

        .student.alt-style.defender::before {
            display: none;
        }

        /* Cone visual representation */
        .cone {
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 30px solid #ff6600;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .cone::after {
            content: '';
            position: absolute;
            top: 30px;
            left: -12px;
            width: 24px;
            height: 8px;
            background-color: #ff4400;
            border-radius: 50%;
        }

        /* Racket visual representation */
        .racket {
            width: 25px;
            height: 40px;
            position: relative;
            background: none;
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .racket::before {
            content: '';
            width: 20px;
            height: 24px;
            border: 3px solid #8B4513;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            position: absolute;
            top: 0;
        }

        .racket::after {
            content: '';
            width: 3px;
            height: 16px;
            background-color: #8B4513;
            position: absolute;
            top: 24px;
            left: 11px;
        }

        /* Shuttlecock visual representation */
        .shuttle {
            width: 20px;
            height: 30px;
            position: relative;
            background: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .shuttle::before {
            content: '';
            width: 12px;
            height: 12px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            bottom: 0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .shuttle::after {
            content: '';
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 18px solid #f8f9fa;
            position: absolute;
            top: 0;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
        }

        /* Net visual representation */
        .equipment-net {
            width: 60px;
            height: 40px;
            background: linear-gradient(90deg, transparent 48%, #333 48%, #333 52%, transparent 52%), 
                        linear-gradient(0deg, transparent 48%, #333 48%, #333 52%, transparent 52%);
            background-size: 8px 8px;
            border: 2px solid #333;
            position: relative;
        }

        .equipment-net::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: -2px;
            right: -2px;
            height: 8px;
            background-color: #654321;
        }

        /* Marker visual representation */
        .marker {
            width: 25px;
            height: 35px;
            position: relative;
            background: none;
        }

        .marker::before {
            content: '';
            width: 20px;
            height: 20px;
            background-color: #ff4444;
            border-radius: 50%;
            position: absolute;
            top: 0;
            left: 2.5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .marker::after {
            content: '';
            width: 3px;
            height: 15px;
            background-color: #333;
            position: absolute;
            bottom: 0;
            left: 11px;
        }

        /* Hoop visual representation */
        .hoop {
            width: 35px;
            height: 35px;
            border: 4px solid #ff8800;
            border-radius: 50%;
            background: rgba(255, 136, 0, 0.1);
            position: relative;
        }

        .hoop::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid #ff6600;
            border-radius: 50%;
            background: transparent;
        }

        /* Ball visual representation */
        .ball {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffff00, #ffcc00);
            border: 2px solid #ffaa00;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .ball::before {
            content: '';
            position: absolute;
            top: 6px;
            left: 6px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
        }

        /* Bench visual representation */
        .bench {
            width: 50px;
            height: 20px;
            background-color: #8B4513;
            border: 2px solid #654321;
            position: relative;
        }

        .bench::before {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 8px;
            right: 8px;
            height: 6px;
            background-color: #654321;
        }

        .bench::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 10px;
            width: 6px;
            height: 4px;
            background-color: #5a3a1a;
            box-shadow: 24px 0 0 #5a3a1a;
        }

        .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 16px;
            height: 16px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            display: none;
        }

        .draggable-item:hover .remove-btn {
            display: block;
        }
        
        .phase-btn {
            background-color: #7f8c8d !important;
        }
        
        .phase-btn.active {
            background-color: #2c3e50 !important;
        }
        
        .drawing-mode {
            cursor: crosshair !important;
        }
        
        .path-line {
            position: absolute;
            height: 3px;
            background-color: #e74c3c;
            transform-origin: left center;
            pointer-events: none;
            z-index: 100;
        }
        
        .path-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 8px solid #e74c3c;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
            pointer-events: none;
            z-index: 101;
        }
        
        .annotation {
            position: absolute;
            background-color: #f1c40f;
            border: 2px solid #f39c12;
            border-radius: 5px;
            padding: 8px;
            font-size: 12px;
            min-width: 80px;
            max-width: 300px;
            width: auto;
            height: auto;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            z-index: 200;
        }
        
        .annotation textarea {
            width: 100%;
            border: none;
            background: transparent;
            resize: none;
            font-size: 11px;
            font-family: inherit;
            overflow: hidden;
            min-height: 16px;
            box-sizing: border-box;
            outline: none;
        }
        
        .phase-content {
            display: none;
        }
        
        .phase-content.active {
            display: block;
        }
        
        .tooltip {
            position: absolute;
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transform: translateY(-8px);
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 200px;
        }
        
        .tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .onboarding-modal {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            max-height: 90vh;
            text-align: center;
            position: relative;
            overflow-y: auto;
        }
        
        .onboarding-modal h2 {
            color: #1f2937;
            margin-bottom: 20px;
            font-size: 2rem;
        }
        
        .onboarding-modal p {
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .onboarding-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
        }
        
        .feature-card {
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            text-align: left;
        }
        
        .feature-card h4 {
            color: #1f2937;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        
        .feature-card p {
            color: #6b7280;
            font-size: 0.9rem;
            margin: 0;
        }
        
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .success-message.show {
            transform: translateX(0);
        }
        
        /* AI Suggestions Modal Styles */
        .ai-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .ai-modal-overlay.show {
            display: flex;
        }
        
        .ai-modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .ai-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 28px;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }
        
        .ai-modal-header h2 {
            color: #1f2937;
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .ai-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #6b7280;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .ai-modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .ai-modal-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 24px 28px;
            line-height: 1.7;
            min-height: 200px;
            max-height: calc(90vh - 180px);
        }
        
        .ai-modal-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .ai-modal-content::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 4px;
        }
        
        .ai-modal-content::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }
        
        #aiSuggestionsModalContent {
            color: #374151;
            font-size: 15px;
        }
        
        #aiSuggestionsModalContent strong {
            color: #1f2937;
            font-weight: 600;
        }
        
        .ai-modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 28px;
            border-top: 1px solid #e5e7eb;
        }
        
        .ai-modal-tip {
            font-size: 13px;
            color: #6b7280;
            font-style: italic;
        }

        /* Mobile-first responsive design */
        
        /* Small screens (mobile phones) */
        @media screen and (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
                text-align: center;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .header p {
                font-size: 0.95rem;
            }
            
            .main-content {
                flex-direction: column;
                min-height: auto;
            }
            
            .controls {
                width: 100%;
                max-height: none;
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
                padding: 15px;
                overflow-y: visible;
            }
            
            .control-section {
                margin-bottom: 10px;
            }
            
            .control-header {
                padding: 15px 20px 12px;
                font-size: 14px;
            }
            
            .control-content {
                padding: 15px 20px;
            }
            
            .control-btn {
                padding: 10px 12px;
                font-size: 13px;
                margin-bottom: 6px;
            }
            
            .court-container {
                margin: 15px;
                min-height: 400px;
            }
            
            .playing-area {
                width: 100%;
                height: 400px;
                min-height: 300px;
            }
            
            /* Smaller modal for mobile */
            .onboarding-modal {
                padding: 20px;
                margin: 15px;
                max-width: 95%;
                max-height: 85vh;
                border-radius: 15px;
            }
            
            .onboarding-modal h2 {
                font-size: 1.5rem;
                margin-bottom: 15px;
            }
            
            .onboarding-modal p {
                font-size: 1rem;
                margin-bottom: 20px;
            }
            
            .onboarding-features {
                grid-template-columns: 1fr;
                gap: 12px;
                margin: 20px 0;
            }
            
            .feature-card {
                padding: 15px;
            }
            
            .feature-card h4 {
                font-size: 0.95rem;
                margin-bottom: 8px;
            }
            
            .feature-card p {
                font-size: 0.85rem;
                margin-bottom: 0;
            }
            
            .ai-modal {
                width: 95%;
                max-height: 85vh;
                margin: 10px;
            }
            
            .ai-modal-content {
                padding: 20px;
                max-height: calc(85vh - 140px);
            }
            
            /* Adjust input fields for mobile */
            input, textarea, select {
                font-size: 16px !important; /* Prevents zoom on iOS */
            }
            
            .tooltip {
                max-width: 150px;
                font-size: 11px;
            }
        }
        
        /* Extra small screens (small mobile phones) */
        @media screen and (max-width: 480px) {
            .onboarding-modal {
                padding: 15px;
                margin: 10px;
                max-width: 98%;
                border-radius: 10px;
            }
            
            .onboarding-modal h2 {
                font-size: 1.3rem;
                margin-bottom: 12px;
            }
            
            .onboarding-modal p {
                font-size: 0.95rem;
                margin-bottom: 15px;
            }
            
            .onboarding-features {
                gap: 10px;
                margin: 15px 0;
            }
            
            .feature-card {
                padding: 12px;
            }
            
            .feature-card h4 {
                font-size: 0.9rem;
                margin-bottom: 6px;
            }
            
            .feature-card p {
                font-size: 0.8rem;
            }
        }
        
        /* Landscape orientation on small screens */
        @media screen and (max-height: 600px) and (orientation: landscape) {
            .onboarding-modal {
                max-height: 95vh;
                padding: 15px 20px;
            }
            
            .onboarding-modal h2 {
                font-size: 1.2rem;
                margin-bottom: 10px;
            }
            
            .onboarding-modal p {
                font-size: 0.9rem;
                margin-bottom: 15px;
            }
            
            .onboarding-features {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                margin: 15px 0;
            }
            
            .feature-card {
                padding: 10px;
            }
            
            .feature-card h4 {
                font-size: 0.85rem;
                margin-bottom: 5px;
            }
            
            .feature-card p {
                font-size: 0.75rem;
                line-height: 1.3;
            }
        }
        
        /* Medium screens (tablets) */
        @media screen and (min-width: 769px) and (max-width: 1024px) {
            .container {
                margin: 15px;
            }
            
            .controls {
                width: 300px;
                min-width: 300px;
            }
            
            .playing-area {
                height: 500px;
            }
            
            .onboarding-features {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* Large screens (landscape tablets, small desktops) */
        @media screen and (min-width: 1025px) {
            .main-content {
                flex-direction: row;
            }
            
            .controls {
                width: 320px;
                min-width: 320px;
                max-height: 80vh;
                overflow-y: auto;
                border-right: 1px solid #e2e8f0;
                border-bottom: none;
            }
            
            .court-container {
                flex: 1;
                margin: 30px;
            }
            
            .playing-area {
                height: 600px;
            }
        }
        
        /* Extra large screens */
        @media screen and (min-width: 1400px) {
            .container {
                max-width: 1600px;
            }
            
            .controls {
                width: 350px;
                min-width: 350px;
            }
            
            .playing-area {
                height: 700px;
            }
        }
        
        /* Landscape orientation adjustments */
        @media screen and (orientation: landscape) and (max-height: 600px) {
            .header {
                padding: 15px 20px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .playing-area {
                height: 300px;
            }
            
            .controls {
                max-height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PE Activity Consultant</h1>
            <p>Complete lesson planning with multiple phases, timers, annotations, and save/load functionality</p>
        </div>
        
        <div class="main-content">
            <div class="controls">
                <div class="control-section">
                    <div class="control-header" onclick="toggleSection(this)">
                        <h3><span>🏟️</span> Layout Format</h3>
                    </div>
                    <div class="control-content">
                        <div style="margin-bottom: 15px;">
                            <label for="layoutType" style="display: block; margin-bottom: 8px; font-weight: 600; color: #334155; font-size: 13px;">Select Layout:</label>
                            <select id="layoutType" onchange="changeLayout()" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; outline: none;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                                <option value="badminton">Badminton Court</option>
                                <option value="basketball">Basketball Court</option>
                                <option value="volleyball">Volleyball Court</option>
                                <option value="soccer">Soccer Field</option>
                                <option value="tennis">Tennis Court</option>
                                <option value="blank">Blank Space (Custom)</option>
                            </select>
                        </div>
                        <div id="customDimensions" style="display: none;">
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 3px; font-size: 12px; color: #64748b;">Width (m):</label>
                                    <input type="number" id="customWidth" value="20" min="5" max="50" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 13px;">
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 3px; font-size: 12px; color: #64748b;">Height (m):</label>
                                    <input type="number" id="customHeight" value="15" min="5" max="50" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 13px;">
                                </div>
                            </div>
                            <button class="control-btn" onclick="applyCustomDimensions()" style="font-size: 12px; padding: 8px 12px;"><span>📐</span> Apply Dimensions</button>
                        </div>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="control-header" onclick="toggleSection(this)">
                        <h3><span>⚽</span> Equipment</h3>
                    </div>
                    <div class="control-content">
                        <button class="control-btn equipment-btn" onclick="addEquipment('cone')" title="Add traffic cone for boundaries"><span>🚧</span> Cone</button>
                        <button class="control-btn equipment-btn" onclick="addEquipment('racket')" title="Add badminton racket"><span>🏸</span> Racket</button>
                        <button class="control-btn equipment-btn" onclick="addEquipment('shuttle')" title="Add shuttlecock"><span>🏸</span> Shuttlecock</button>
                        <button class="control-btn equipment-btn" onclick="addEquipment('equipment-net')" title="Add practice net"><span>🥅</span> Net</button>
                        <button class="control-btn equipment-btn" onclick="addEquipment('marker')" title="Add field marker"><span>🚩</span> Marker</button>
                        <button class="control-btn equipment-btn" onclick="addEquipment('hoop')" title="Add target hoop"><span>⭕</span> Hoop</button>
                        <button class="control-btn equipment-btn" onclick="addEquipment('ball')" title="Add ball"><span>🟡</span> Ball</button>
                        <button class="control-btn equipment-btn" onclick="addEquipment('bench')" title="Add bench for seating"><span>🪑</span> Bench</button>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="control-header" onclick="toggleSection(this)">
                        <h3><span>👥</span> Students</h3>
                    </div>
                    <div class="control-content">
                        <button class="control-btn" onclick="addStudent('attacker')" title="Add attacking player"><span>🔴</span> Attacker</button>
                        <button class="control-btn" onclick="addStudent('defender')" title="Add defending player"><span>🔵</span> Defender</button>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="control-header" onclick="toggleSection(this)">
                        <h3><span>📋</span> Activity Rules</h3>
                    </div>
                    <div class="control-content">
                        <div style="margin-bottom: 15px;">
                            <label for="activityName" style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155; font-size: 13px;">Activity Name:</label>
                            <input type="text" id="activityName" placeholder="e.g., Doubles Rally Game" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 13px; outline: none;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="lessonObjective" style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155; font-size: 13px;">Lesson Objective:</label>
                            <textarea id="lessonObjective" placeholder="What should students learn or achieve by the end of this lesson?" rows="3" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 13px; resize: vertical; font-family: inherit; outline: none;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'"></textarea>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="activityRules" style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155; font-size: 13px;">Rules & Instructions:</label>
                            <textarea id="activityRules" placeholder="Describe the activity rules, objectives, and how students should play..." rows="4" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 13px; resize: vertical; font-family: inherit; outline: none;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'"></textarea>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="winningConditions" style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155; font-size: 13px;">Winning Conditions:</label>
                            <textarea id="winningConditions" placeholder="How do students win? What are the success criteria?" rows="3" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 13px; resize: vertical; font-family: inherit; outline: none;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'"></textarea>
                        </div>
                        <div>
                            <label for="skillFocus" style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155; font-size: 13px;">Skills Being Practiced:</label>
                            <input type="text" id="skillFocus" placeholder="e.g., Net play, Doubles positioning, Communication" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 13px; outline: none;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="control-header" onclick="toggleSection(this)">
                        <h3><span>📋</span> Lesson Plans</h3>
                    </div>
                    <div class="control-content">
                        <input type="text" id="planName" placeholder="Enter lesson plan name..." style="width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s; outline: none;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        <button class="control-btn success-btn" onclick="savePlan()" title="Save current lesson plan"><span>💾</span> Save Plan</button>
                        <select id="savedPlans" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white;">
                            <option value="">Select saved plan...</option>
                        </select>
                        <button class="control-btn" onclick="loadPlan()" title="Load selected lesson plan"><span>📂</span> Load Plan</button>
                        <button class="control-btn danger-btn" onclick="deletePlan()" title="Delete selected lesson plan"><span>🗑️</span> Delete Plan</button>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="control-header" onclick="toggleSection(this)">
                        <h3><span>⏱️</span> Activity Phases</h3>
                    </div>
                    <div class="control-content">
                        <div id="phaseButtons" style="display: grid; grid-template-columns: 1fr; gap: 8px; margin-bottom: 20px;">
                            <button class="control-btn phase-btn active" onclick="switchPhase('warmup')" data-phase="warmup" title="Warm-up phase"><span>🔥</span> Warm-up</button>
                            <button class="control-btn phase-btn" onclick="switchPhase('main')" data-phase="main" title="Main activity phase"><span>⚡</span> Main Activity</button>
                            <button class="control-btn phase-btn" onclick="switchPhase('cooldown')" data-phase="cooldown" title="Cool-down phase"><span>❄️</span> Cool-down</button>
                        </div>
                        <div id="phaseTimer" style="text-align: center; font-weight: bold; font-size: 24px; color: #334155; margin-bottom: 15px; font-family: 'Courier New', monospace;">00:00</div>
                        <div id="timerControls">
                            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                <input type="number" id="timerMinutes" placeholder="Min" min="0" max="60" style="flex: 1; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; text-align: center;">
                                <input type="number" id="timerSeconds" placeholder="Sec" min="0" max="59" style="flex: 1; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; text-align: center;">
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="control-btn success-btn" onclick="startTimer()" title="Start the timer" style="flex: 1;"><span>▶️</span> Start</button>
                                <button class="control-btn danger-btn" onclick="stopTimer()" title="Stop the timer" style="flex: 1;"><span>⏹️</span> Stop</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="control-header" onclick="toggleSection(this)">
                        <h3><span>✏️</span> Drawing Tools</h3>
                    </div>
                    <div class="control-content">
                        <button class="control-btn purple-btn" onclick="toggleDrawing()" id="drawBtn" title="Draw movement paths and arrows"><span>✏️</span> Draw Paths</button>
                        <button class="control-btn secondary-btn" onclick="clearPaths()" title="Clear all drawn paths"><span>🧹</span> Clear Paths</button>
                        <button class="control-btn warning-btn" onclick="addAnnotation()" title="Add instruction note"><span>📝</span> Add Note</button>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="control-header" onclick="toggleSection(this)">
                        <h3><span>🤖</span> AI Assistant</h3>
                    </div>
                    <div class="control-content">
                        <div id="apiKeyStatus" style="padding: 10px; margin-bottom: 15px; border-radius: 8px; font-size: 12px; text-align: center;">
                            <span id="apiKeyStatusText">Loading API configuration...</span>
                        </div>
                        <button class="control-btn purple-btn" onclick="analyzeLayout()" id="analyzeBtn" title="Send court layout to AI for analysis and suggestions"><span>🧠</span> Analyze Layout</button>
                        <div id="aiStatus" style="text-align: center; font-size: 12px; color: #6b7280; margin: 10px 0; display: none;"></div>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="control-header" onclick="toggleSection(this)">
                        <h3><span>🔧</span> Actions</h3>
                    </div>
                    <div class="control-content">
                        <button class="control-btn purple-btn" onclick="exportToPDF()" title="Export lesson plan to PDF"><span>📄</span> Export PDF</button>
                        <button class="control-btn secondary-btn" onclick="clearCourt()" title="Clear everything from court"><span>🧽</span> Clear Court</button>
                    </div>
                </div>
            </div>
            
            <div class="court-container">
                <div class="playing-area badminton-court" id="court">
                    <div class="court-lines" id="courtLines">
                        <div class="court-line outer-boundary"></div>
                        <div class="court-line center-line"></div>
                        <div class="court-line service-lines front-service-line"></div>
                        <div class="court-line service-lines back-service-line"></div>
                    </div>
                    <div class="net" id="courtNet"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="onboardingOverlay" class="onboarding-overlay">
        <div class="onboarding-modal">
            <h2>Welcome to PE Activity Consultant! 🏸</h2>
            <p>Plan amazing PE lessons with drag-and-drop simplicity. Here's what you can do:</p>
            
            <div class="onboarding-features">
                <div class="feature-card">
                    <h4>📋 Add Equipment & Students</h4>
                    <p>Drag realistic equipment and named students onto the court</p>
                </div>
                <div class="feature-card">
                    <h4>⏱️ Plan Activity Phases</h4>
                    <p>Organize warm-up, main activity, and cool-down with timers</p>
                </div>
                <div class="feature-card">
                    <h4>✏️ Draw Movement Paths</h4>
                    <p>Show student movement patterns with arrows and lines</p>
                </div>
                <div class="feature-card">
                    <h4>💾 Save & Share</h4>
                    <p>Save lesson plans and export to PDF for sharing</p>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="control-btn secondary-btn" onclick="closeOnboarding()" style="margin: 0;">Skip Tour</button>
                <button class="control-btn" onclick="startTour()" style="margin: 0;">Start Quick Tour</button>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    <div class="success-message" id="successMessage"></div>

    <!-- AI Suggestions Modal -->
    <div id="aiSuggestionsModal" class="ai-modal-overlay">
        <div class="ai-modal">
            <div class="ai-modal-header">
                <h2><span>🤖</span> AI Analysis & Suggestions</h2>
                <button class="ai-modal-close" onclick="closeAISuggestionsModal()">×</button>
            </div>
            <div class="ai-modal-content">
                <div id="aiSuggestionsModalContent"></div>
            </div>
            <div class="ai-modal-footer">
                <button class="control-btn" onclick="closeAISuggestionsModal()">Close</button>
                <div class="ai-modal-tip">
                    💡 Tip: Try different layouts and get new suggestions to improve your lesson plans!
                </div>
            </div>
        </div>
    </div>

    <script>
        let itemCounter = 0;
        let draggedElement = null;
        let dragOffset = { x: 0, y: 0 };
        let currentPhase = 'warmup';
        let isDrawingMode = false;
        let drawingPath = null;
        let drawingStartPoint = null;
        let timerInterval = null;
        let timerSeconds = 0;
        let lessonPlans = JSON.parse(localStorage.getItem('lessonPlans') || '{}');
        let currentLayout = 'badminton';

        // Helper function to check if we're in landscape mode
        function isLandscapeMode() {
            return window.matchMedia("(orientation: landscape)").matches;
        }

        // Helper function to get mouse position relative to court
        function getMousePosition(e, court) {
            const courtRect = court.getBoundingClientRect();
            
            let clientX, clientY;
            if (e.type === 'mousemove' || e.type === 'mousedown') {
                clientX = e.clientX;
                clientY = e.clientY;
            } else {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            }
            
            // Get position relative to court container
            // No coordinate transformation needed - court stays in natural orientation
            let x = clientX - courtRect.left;
            let y = clientY - courtRect.top;
            
            return { x, y };
        }

        function addEquipment(type) {
            const court = document.getElementById('court');
            const item = document.createElement('div');
            item.className = `draggable-item ${type}`;
            item.id = 'item-' + (++itemCounter);
            item.dataset.phase = currentPhase;
            
            item.style.left = '50px';
            item.style.top = '50px';
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = '×';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                court.removeChild(item);
            };
            
            item.appendChild(removeBtn);
            court.appendChild(item);
            
            makeDraggable(item);
        }

        function addStudent(type) {
            const name = prompt(`Enter student name (or leave blank for ${type.toUpperCase()}):`)
            const court = document.getElementById('court');
            const item = document.createElement('div');
            item.className = `draggable-item student ${type}`;
            item.id = 'item-' + (++itemCounter);
            item.dataset.phase = currentPhase;
            
            if (name && name.trim()) {
                const nameLabel = document.createElement('div');
                nameLabel.textContent = name.trim();
                nameLabel.style.position = 'absolute';
                nameLabel.style.bottom = '-15px';
                nameLabel.style.left = '50%';
                nameLabel.style.transform = 'translateX(-50%)';
                nameLabel.style.fontSize = '8px';
                nameLabel.style.color = type === 'attacker' ? '#e74c3c' : '#3498db';
                nameLabel.style.fontWeight = 'bold';
                nameLabel.style.whiteSpace = 'nowrap';
                item.appendChild(nameLabel);
            }
            
            item.style.left = '100px';
            item.style.top = '100px';
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = '×';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                court.removeChild(item);
            };
            
            item.appendChild(removeBtn);
            court.appendChild(item);
            
            makeDraggable(item);
        }

        function makeDraggable(element) {
            element.addEventListener('mousedown', startDrag);
            element.addEventListener('touchstart', startDrag);
        }

        function startDrag(e) {
            // Don't start drag if user is typing in a textarea
            if (e.target.tagName === 'TEXTAREA' && document.activeElement === e.target) {
                return;
            }
            
            e.preventDefault();
            // Find the draggable element (could be the target itself or a parent)
            draggedElement = e.target.closest('.draggable-item, .annotation') || e.target;
            
            const court = document.getElementById('court');
            const mousePos = getMousePosition(e, court);
            
            // Get current element position
            const currentLeft = parseInt(draggedElement.style.left) || 0;
            const currentTop = parseInt(draggedElement.style.top) || 0;
            
            // Calculate offset between mouse position and element position
            dragOffset.x = mousePos.x - currentLeft;
            dragOffset.y = mousePos.y - currentTop;
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('touchmove', drag);
            document.addEventListener('touchend', stopDrag);
            
            draggedElement.style.zIndex = '1000';
        }

        function drag(e) {
            if (!draggedElement) return;
            
            e.preventDefault();
            const court = document.getElementById('court');
            const courtContainer = court.parentElement;
            const mousePos = getMousePosition(e, court);
            
            // Calculate new position based on mouse position minus offset
            let newX = mousePos.x - dragOffset.x;
            let newY = mousePos.y - dragOffset.y;
            
            // For annotations/notes, allow dragging outside court boundaries
            // but constrain to the court container area
            if (draggedElement.classList.contains('annotation')) {
                const elementRect = draggedElement.getBoundingClientRect();
                const containerRect = courtContainer.getBoundingClientRect();
                const courtRect = court.getBoundingClientRect();
                
                // Calculate relative position within the court container
                const containerMaxX = courtContainer.clientWidth - elementRect.width;
                const containerMaxY = courtContainer.clientHeight - elementRect.height;
                
                // Allow movement within the entire court container
                newX = Math.max(-20, Math.min(newX, containerMaxX));
                newY = Math.max(-20, Math.min(newY, containerMaxY));
            } else {
                // For equipment and students, constrain to court boundaries
                const elementRect = draggedElement.getBoundingClientRect();
                const courtRect = court.getBoundingClientRect();
                const maxX = court.clientWidth - (elementRect.width);
                const maxY = court.clientHeight - (elementRect.height);
                
                newX = Math.max(0, Math.min(newX, maxX));
                newY = Math.max(0, Math.min(newY, maxY));
            }
            
            draggedElement.style.left = newX + 'px';
            draggedElement.style.top = newY + 'px';
        }

        function stopDrag() {
            if (draggedElement) {
                draggedElement.style.zIndex = 'auto';
                draggedElement = null;
            }
            
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchmove', drag);
            document.removeEventListener('touchend', stopDrag);
        }

        function clearCourt() {
            const court = document.getElementById('court');
            const items = court.querySelectorAll('.draggable-item, .path-line, .path-arrow, .annotation');
            items.forEach(item => court.removeChild(item));
            itemCounter = 0;
        }
        
        function changeLayout() {
            const layoutType = document.getElementById('layoutType').value;
            const court = document.getElementById('court');
            const courtLines = document.getElementById('courtLines');
            const courtNet = document.getElementById('courtNet');
            const customDimensions = document.getElementById('customDimensions');
            
            // Remove all existing layout classes
            court.className = 'playing-area';
            
            // Add new layout class
            court.classList.add(layoutType + '-court');
            if (layoutType === 'blank') {
                court.classList.add('blank-space');
            }
            
            // Show/hide custom dimensions for blank space
            if (layoutType === 'blank') {
                customDimensions.style.display = 'block';
            } else {
                customDimensions.style.display = 'none';
            }
            
            // Update court lines based on layout
            updateCourtLines(layoutType);
            
            currentLayout = layoutType;
        }
        
        function updateCourtLines(layoutType) {
            const courtLines = document.getElementById('courtLines');
            const courtNet = document.getElementById('courtNet');
            
            // Clear existing lines and nets
            courtLines.innerHTML = '';
            courtNet.style.display = 'none';
            
            switch(layoutType) {
                case 'badminton':
                    courtLines.innerHTML = `
                        <div class="court-line outer-boundary"></div>
                        <div class="court-line center-line"></div>
                        <div class="court-line service-lines front-service-line"></div>
                        <div class="court-line service-lines back-service-line"></div>
                    `;
                    courtNet.style.display = 'block';
                    break;
                    
                case 'basketball':
                    courtLines.innerHTML = `
                        <div class="court-line outer-boundary"></div>
                        <div class="court-line center-line"></div>
                    `;
                    // Add basketball hoops styling here if needed
                    break;
                    
                case 'volleyball':
                    courtLines.innerHTML = `
                        <div class="court-line outer-boundary"></div>
                        <div class="court-line center-line"></div>
                    `;
                    courtNet.style.display = 'block';
                    courtNet.style.height = '8px';
                    break;
                    
                case 'soccer':
                    courtLines.innerHTML = `
                        <div class="court-line outer-boundary"></div>
                        <div class="court-line center-line"></div>
                    `;
                    break;
                    
                case 'tennis':
                    courtLines.innerHTML = `
                        <div class="court-line outer-boundary"></div>
                        <div class="court-line center-line"></div>
                        <div class="court-line service-lines front-service-line"></div>
                        <div class="court-line service-lines back-service-line"></div>
                    `;
                    courtNet.style.display = 'block';
                    courtNet.style.height = '4px';
                    break;
                    
                case 'blank':
                    // No lines for blank space
                    break;
            }
        }
        
        function applyCustomDimensions() {
            const width = document.getElementById('customWidth').value;
            const height = document.getElementById('customHeight').value;
            const court = document.getElementById('court');
            
            // Calculate pixel dimensions (rough conversion: 1m = 30px)
            const pixelWidth = Math.max(300, Math.min(1200, width * 30));
            const pixelHeight = Math.max(200, Math.min(800, height * 30));
            
            court.style.width = pixelWidth + 'px';
            court.style.height = pixelHeight + 'px';
            court.style.margin = '20px auto';
            
            // Clear any existing items when dimensions change
            clearCourt();
        }
        
        function savePlan() {
            const planName = document.getElementById('planName').value.trim();
            if (!planName) {
                alert('Please enter a lesson plan name');
                return;
            }
            
            const court = document.getElementById('court');
            const items = [];
            
            court.querySelectorAll('.draggable-item').forEach(item => {
                const rect = item.getBoundingClientRect();
                const courtRect = court.getBoundingClientRect();
                items.push({
                    id: item.id,
                    className: item.className,
                    left: item.style.left,
                    top: item.style.top,
                    phase: item.dataset.phase || 'warmup',
                    text: item.querySelector('div') ? item.querySelector('div').textContent : ''
                });
            });
            
            const annotations = [];
            court.querySelectorAll('.annotation').forEach(ann => {
                annotations.push({
                    left: ann.style.left,
                    top: ann.style.top,
                    text: ann.querySelector('textarea').value,
                    phase: ann.dataset.phase || 'warmup'
                });
            });
            
            lessonPlans[planName] = {
                items,
                annotations,
                activityDetails: {
                    name: document.getElementById('activityName').value.trim(),
                    objective: document.getElementById('lessonObjective').value.trim(),
                    rules: document.getElementById('activityRules').value.trim(),
                    winningConditions: document.getElementById('winningConditions').value.trim(),
                    skillFocus: document.getElementById('skillFocus').value.trim()
                },
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('lessonPlans', JSON.stringify(lessonPlans));
            updatePlanSelect();
            alert('Lesson plan saved successfully!');
            document.getElementById('planName').value = '';
        }
        
        function loadPlan() {
            const select = document.getElementById('savedPlans');
            const planName = select.value;
            if (!planName) {
                alert('Please select a lesson plan to load');
                return;
            }
            
            clearCourt();
            const plan = lessonPlans[planName];
            const court = document.getElementById('court');
            
            // Load activity details if they exist
            if (plan.activityDetails) {
                document.getElementById('activityName').value = plan.activityDetails.name || '';
                document.getElementById('lessonObjective').value = plan.activityDetails.objective || '';
                document.getElementById('activityRules').value = plan.activityDetails.rules || '';
                document.getElementById('winningConditions').value = plan.activityDetails.winningConditions || '';
                document.getElementById('skillFocus').value = plan.activityDetails.skillFocus || '';
            } else {
                // Clear fields if no activity details saved
                document.getElementById('activityName').value = '';
                document.getElementById('lessonObjective').value = '';
                document.getElementById('activityRules').value = '';
                document.getElementById('winningConditions').value = '';
                document.getElementById('skillFocus').value = '';
            }
            
            plan.items.forEach(itemData => {
                const item = document.createElement('div');
                item.className = itemData.className;
                item.id = itemData.id;
                item.style.left = itemData.left;
                item.style.top = itemData.top;
                item.dataset.phase = itemData.phase || 'warmup';
                
                if (itemData.text && item.classList.contains('student')) {
                    const nameLabel = document.createElement('div');
                    nameLabel.textContent = itemData.text;
                    nameLabel.style.position = 'absolute';
                    nameLabel.style.bottom = '-15px';
                    nameLabel.style.left = '50%';
                    nameLabel.style.transform = 'translateX(-50%)';
                    nameLabel.style.fontSize = '8px';
                    nameLabel.style.color = item.classList.contains('attacker') ? '#e74c3c' : '#3498db';
                    nameLabel.style.fontWeight = 'bold';
                    nameLabel.style.whiteSpace = 'nowrap';
                    item.appendChild(nameLabel);
                }
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = '×';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    court.removeChild(item);
                };
                
                item.appendChild(removeBtn);
                court.appendChild(item);
                makeDraggable(item);
            });
            
            plan.annotations.forEach(annData => {
                const ann = document.createElement('div');
                ann.className = 'annotation';
                ann.style.left = annData.left;
                ann.style.top = annData.top;
                ann.dataset.phase = annData.phase || 'warmup';
                
                const textarea = document.createElement('textarea');
                textarea.value = annData.text;
                textarea.rows = 1;
                
                // Add input event listener for auto-resizing
                textarea.addEventListener('input', function() {
                    autoResizeTextarea(this);
                });
                
                // Add focus and blur events for better UX
                textarea.addEventListener('focus', function() {
                    ann.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.4), 0 0 0 2px #3b82f6';
                });
                
                textarea.addEventListener('blur', function() {
                    ann.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.3)';
                });
                
                ann.appendChild(textarea);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = '×';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    court.removeChild(ann);
                };
                ann.appendChild(removeBtn);
                
                court.appendChild(ann);
                makeDraggable(ann);
                
                // Auto-resize to fit loaded content
                autoResizeTextarea(textarea);
            });
            
            itemCounter = Math.max(...plan.items.map(item => parseInt(item.id.split('-')[1]))) || 0;
            switchPhase(currentPhase);
        }
        
        function deletePlan() {
            const select = document.getElementById('savedPlans');
            const planName = select.value;
            if (!planName) {
                alert('Please select a lesson plan to delete');
                return;
            }
            
            if (confirm(`Are you sure you want to delete "${planName}"?`)) {
                delete lessonPlans[planName];
                localStorage.setItem('lessonPlans', JSON.stringify(lessonPlans));
                updatePlanSelect();
                alert('Lesson plan deleted successfully!');
            }
        }
        
        function updatePlanSelect() {
            const select = document.getElementById('savedPlans');
            select.innerHTML = '<option value="">Select saved plan...</option>';
            Object.keys(lessonPlans).forEach(planName => {
                const option = document.createElement('option');
                option.value = planName;
                option.textContent = planName;
                select.appendChild(option);
            });
        }
        
        function switchPhase(phase) {
            currentPhase = phase;
            document.querySelectorAll('.phase-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-phase="${phase}"]`).classList.add('active');
            
            const court = document.getElementById('court');
            court.querySelectorAll('.draggable-item, .annotation').forEach(item => {
                const itemPhase = item.dataset.phase || 'warmup';
                item.style.display = itemPhase === phase ? 'flex' : 'none';
            });
        }
        
        function toggleDrawing() {
            isDrawingMode = !isDrawingMode;
            const btn = document.getElementById('drawBtn');
            const court = document.getElementById('court');
            
            if (isDrawingMode) {
                btn.textContent = 'Stop Drawing';
                btn.style.backgroundColor = '#e74c3c';
                court.classList.add('drawing-mode');
                court.addEventListener('click', handleDrawingClick);
            } else {
                btn.textContent = 'Draw Paths';
                btn.style.backgroundColor = '#9b59b6';
                court.classList.remove('drawing-mode');
                court.removeEventListener('click', handleDrawingClick);
                drawingPath = null;
                drawingStartPoint = null;
            }
        }
        
        function handleDrawingClick(e) {
            if (!isDrawingMode || e.target.classList.contains('draggable-item')) return;
            
            const court = document.getElementById('court');
            const rect = court.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (!drawingStartPoint) {
                drawingStartPoint = { x, y };
            } else {
                drawPath(drawingStartPoint, { x, y });
                drawingStartPoint = null;
            }
        }
        
        function drawPath(start, end) {
            const court = document.getElementById('court');
            const dx = end.x - start.x;
            const dy = end.y - start.y;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            const line = document.createElement('div');
            line.className = 'path-line';
            line.style.left = start.x + 'px';
            line.style.top = start.y + 'px';
            line.style.width = length + 'px';
            line.style.transform = `rotate(${angle}deg)`;
            court.appendChild(line);
            
            const arrow = document.createElement('div');
            arrow.className = 'path-arrow';
            arrow.style.left = (end.x - 8) + 'px';
            arrow.style.top = (end.y - 4) + 'px';
            arrow.style.transform = `rotate(${angle}deg)`;
            court.appendChild(arrow);
        }
        
        function clearPaths() {
            const court = document.getElementById('court');
            court.querySelectorAll('.path-line, .path-arrow').forEach(path => {
                court.removeChild(path);
            });
        }
        
        function autoResizeTextarea(textarea) {
            // Reset height to auto to get the correct scrollHeight
            textarea.style.height = 'auto';
            
            // Set height based on scroll height, with some padding
            const newHeight = Math.max(16, textarea.scrollHeight);
            textarea.style.height = newHeight + 'px';
            
            // Also adjust width based on content
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.visibility = 'hidden';
            tempDiv.style.fontSize = '11px';
            tempDiv.style.fontFamily = textarea.style.fontFamily || 'inherit';
            tempDiv.style.whiteSpace = 'pre-wrap';
            tempDiv.style.wordBreak = 'break-word';
            tempDiv.textContent = textarea.value || textarea.placeholder;
            
            document.body.appendChild(tempDiv);
            const contentWidth = Math.max(80, Math.min(300, tempDiv.offsetWidth + 20));
            document.body.removeChild(tempDiv);
            
            // Set the textarea width
            textarea.parentElement.style.width = contentWidth + 'px';
        }

        function addAnnotation() {
            const court = document.getElementById('court');
            const ann = document.createElement('div');
            ann.className = 'annotation';
            ann.style.left = '150px';
            ann.style.top = '150px';
            ann.dataset.phase = currentPhase;
            
            const textarea = document.createElement('textarea');
            textarea.placeholder = 'Enter instruction...';
            textarea.rows = 1;
            
            // Add input event listener for auto-resizing
            textarea.addEventListener('input', function() {
                autoResizeTextarea(this);
            });
            
            // Add focus and blur events for better UX
            textarea.addEventListener('focus', function() {
                ann.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.4), 0 0 0 2px #3b82f6';
            });
            
            textarea.addEventListener('blur', function() {
                ann.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.3)';
            });
            
            ann.appendChild(textarea);
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = '×';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                court.removeChild(ann);
            };
            ann.appendChild(removeBtn);
            
            court.appendChild(ann);
            makeDraggable(ann);
            
            // Initial resize and focus
            autoResizeTextarea(textarea);
            textarea.focus();
        }
        
        function startTimer() {
            const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
            timerSeconds = minutes * 60 + seconds;
            
            if (timerSeconds <= 0) {
                alert('Please set a valid time');
                return;
            }
            
            timerInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();
                
                if (timerSeconds <= 0) {
                    stopTimer();
                    alert('Time\'s up!');
                }
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            document.getElementById('phaseTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function exportToPDF() {
            alert('PDF export feature would integrate with a library like jsPDF or html2canvas. This is a demo showing where the feature would be implemented.');
        }
        
        function toggleSection(header) {
            const section = header.parentElement;
            section.classList.toggle('collapsed');
        }
        
        // AI Assistant Functions
        function captureCourtLayout() {
            const court = document.getElementById('court');
            const courtRect = court.getBoundingClientRect();
            const layout = {
                phase: currentPhase,
                courtDimensions: {
                    width: court.clientWidth,
                    height: court.clientHeight
                },
                activityDetails: {
                    name: document.getElementById('activityName').value.trim(),
                    objective: document.getElementById('lessonObjective').value.trim(),
                    rules: document.getElementById('activityRules').value.trim(),
                    winningConditions: document.getElementById('winningConditions').value.trim(),
                    skillFocus: document.getElementById('skillFocus').value.trim()
                },
                elements: [],
                annotations: [],
                paths: []
            };
            
            // Capture draggable items (equipment and students)
            court.querySelectorAll('.draggable-item').forEach(item => {
                if (item.style.display !== 'none') {
                    const rect = item.getBoundingClientRect();
                    const element = {
                        type: getElementType(item),
                        position: {
                            x: parseInt(item.style.left) || 0,
                            y: parseInt(item.style.top) || 0,
                            // Convert to percentage for better description
                            xPercent: Math.round(((parseInt(item.style.left) || 0) / court.clientWidth) * 100),
                            yPercent: Math.round(((parseInt(item.style.top) || 0) / court.clientHeight) * 100)
                        },
                        phase: item.dataset.phase || 'warmup'
                    };
                    
                    // Add name for students
                    if (item.classList.contains('student')) {
                        const nameLabel = item.querySelector('div');
                        if (nameLabel && !nameLabel.classList.contains('remove-btn')) {
                            element.name = nameLabel.textContent;
                        }
                        element.role = item.classList.contains('attacker') ? 'attacker' : 'defender';
                    }
                    
                    layout.elements.push(element);
                }
            });
            
            // Capture annotations
            court.querySelectorAll('.annotation').forEach(ann => {
                if (ann.style.display !== 'none') {
                    const textarea = ann.querySelector('textarea');
                    if (textarea && textarea.value.trim()) {
                        layout.annotations.push({
                            text: textarea.value.trim(),
                            position: {
                                x: parseInt(ann.style.left) || 0,
                                y: parseInt(ann.style.top) || 0,
                                xPercent: Math.round(((parseInt(ann.style.left) || 0) / court.clientWidth) * 100),
                                yPercent: Math.round(((parseInt(ann.style.top) || 0) / court.clientHeight) * 100)
                            },
                            phase: ann.dataset.phase || 'warmup'
                        });
                    }
                }
            });
            
            // Capture drawing paths
            const lines = court.querySelectorAll('.path-line');
            const arrows = court.querySelectorAll('.path-arrow');
            if (lines.length > 0) {
                layout.paths = Array.from(lines).map((line, index) => {
                    return {
                        type: 'movement_path',
                        startX: parseInt(line.style.left) || 0,
                        startY: parseInt(line.style.top) || 0,
                        length: parseInt(line.style.width) || 0,
                        angle: extractRotationAngle(line.style.transform)
                    };
                });
            }
            
            return layout;
        }
        
        function getElementType(element) {
            if (element.classList.contains('student')) {
                return element.classList.contains('attacker') ? 'attacker' : 'defender';
            } else if (element.classList.contains('cone')) {
                return 'cone';
            } else if (element.classList.contains('racket')) {
                return 'racket';
            } else if (element.classList.contains('shuttle')) {
                return 'shuttlecock';
            } else if (element.classList.contains('equipment-net')) {
                return 'net';
            } else if (element.classList.contains('marker')) {
                return 'marker';
            } else if (element.classList.contains('hoop')) {
                return 'hoop';
            } else if (element.classList.contains('ball')) {
                return 'ball';
            } else if (element.classList.contains('bench')) {
                return 'bench';
            }
            return 'unknown';
        }
        
        function extractRotationAngle(transform) {
            const match = transform.match(/rotate\(([^)]+)\)/);
            return match ? parseFloat(match[1]) : 0;
        }
        
        function generateLayoutDescription(layout) {
            let description = `This is a PE lesson layout for the ${layout.phase} phase:\n\n`;
            
            // Include activity details if provided
            if (layout.activityDetails.name || layout.activityDetails.objective || layout.activityDetails.rules || layout.activityDetails.winningConditions || layout.activityDetails.skillFocus) {
                description += `ACTIVITY DETAILS:\n`;
                if (layout.activityDetails.name) {
                    description += `- Activity Name: ${layout.activityDetails.name}\n`;
                }
                if (layout.activityDetails.objective) {
                    description += `- Lesson Objective: ${layout.activityDetails.objective}\n`;
                }
                if (layout.activityDetails.skillFocus) {
                    description += `- Skills Focus: ${layout.activityDetails.skillFocus}\n`;
                }
                if (layout.activityDetails.rules) {
                    description += `- Rules & Instructions: ${layout.activityDetails.rules}\n`;
                }
                if (layout.activityDetails.winningConditions) {
                    description += `- Winning Conditions: ${layout.activityDetails.winningConditions}\n`;
                }
                description += `\n`;
            }
            
            description += `PLAYING AREA SETUP:\n`;
            description += `- Playing area dimensions: ${layout.courtDimensions.width}x${layout.courtDimensions.height} pixels\n`;
            description += `- Current phase: ${layout.phase}\n\n`;
            
            if (layout.elements.length > 0) {
                description += `EQUIPMENT & PARTICIPANTS:\n`;
                layout.elements.forEach((element, index) => {
                    description += `${index + 1}. ${element.type.toUpperCase()}`;
                    if (element.name) {
                        description += ` (${element.name})`;
                    }
                    if (element.role) {
                        description += ` - Role: ${element.role}`;
                    }
                    description += ` at position (${element.xPercent}%, ${element.yPercent}% from top-left)\n`;
                });
                description += `\n`;
            }
            
            if (layout.annotations.length > 0) {
                description += `INSTRUCTOR NOTES:\n`;
                layout.annotations.forEach((ann, index) => {
                    description += `${index + 1}. "${ann.text}" at (${ann.xPercent}%, ${ann.yPercent}%)\n`;
                });
                description += `\n`;
            }
            
            if (layout.paths.length > 0) {
                description += `MOVEMENT PATHS:\n`;
                description += `- ${layout.paths.length} movement arrows/paths drawn on playing area\n`;
                description += `- These indicate planned participant movements or object trajectories\n\n`;
            }
            
            return description;
        }
        
        function showAIStatus(message, isError = false) {
            const statusDiv = document.getElementById('aiStatus');
            statusDiv.textContent = message;
            statusDiv.style.color = isError ? '#ef4444' : '#6b7280';
            statusDiv.style.display = 'block';
            
            if (!isError) {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        function showAISuggestions(suggestions) {
            const modalOverlay = document.getElementById('aiSuggestionsModal');
            const modalContent = document.getElementById('aiSuggestionsModalContent');
            
            // Format the suggestions for better readability - more careful processing
            let formattedSuggestions = suggestions
                .replace(/\n\n/g, '<br><br>')  // Double line breaks first
                .replace(/\n/g, '<br>')        // Single line breaks
                .replace(/^(\d+\.\s)/gm, '<br><strong>$1</strong>')  // Bold numbered points at start of line
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')  // Bold text between ** (non-greedy)
                .replace(/^\s*<br>/, '');  // Remove leading breaks
            
            modalContent.innerHTML = formattedSuggestions;
            modalOverlay.classList.add('show');
        }
        
        function clearAISuggestions() {
            const modalOverlay = document.getElementById('aiSuggestionsModal');
            modalOverlay.classList.remove('show');
            document.getElementById('aiSuggestionsModalContent').innerHTML = '';
        }
        
        function closeAISuggestionsModal() {
            const modalOverlay = document.getElementById('aiSuggestionsModal');
            modalOverlay.classList.remove('show');
        }
        
        let geminiApiKey = '';

        async function loadApiConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                geminiApiKey = config.geminiApiKey;
                
                const statusDiv = document.getElementById('apiKeyStatus');
                const statusText = document.getElementById('apiKeyStatusText');
                
                if (geminiApiKey) {
                    statusDiv.style.backgroundColor = '#d1fae5';
                    statusDiv.style.border = '1px solid #10b981';
                    statusText.textContent = '🤖 AI Assistant Ready';
                    statusText.style.color = '#065f46';
                } else {
                    statusDiv.style.backgroundColor = '#fee2e2';
                    statusDiv.style.border = '1px solid #ef4444';
                    statusText.textContent = '⚠️ No API key configured in .env file';
                    statusText.style.color = '#991b1b';
                }
            } catch (error) {
                const statusDiv = document.getElementById('apiKeyStatus');
                const statusText = document.getElementById('apiKeyStatusText');
                statusDiv.style.backgroundColor = '#fef3c7';
                statusDiv.style.border = '1px solid #f59e0b';
                statusText.textContent = '⚠️ Could not load API config';
                statusText.style.color = '#92400e';
            }
        }

        async function analyzeLayout() {
            if (!geminiApiKey) {
                alert('API key not configured. Please add GOOGLE_GEMINI_API_KEY to your .env file.');
                return;
            }
            
            // Capture current layout
            const layout = captureCourtLayout();
            
            if (layout.elements.length === 0 && layout.annotations.length === 0 && layout.paths.length === 0) {
                alert('Please add some equipment, students, or annotations to the court before analyzing.');
                return;
            }
            
            const description = generateLayoutDescription(layout);
            
            // Show loading status
            showAIStatus('Analyzing layout with AI...', false);
            const analyzeBtn = document.getElementById('analyzeBtn');
            const originalText = analyzeBtn.innerHTML;
            analyzeBtn.innerHTML = '<span>⏳</span> Analyzing...';
            analyzeBtn.disabled = true;
            
            try {
                let prompt = `You are an expert Physical Education teacher with experience across multiple sports and activities. Please analyze this lesson layout and provide constructive feedback and suggestions.

${description}

Based on the activity details, court/field layout, and current phase, please provide:
1. Assessment of the current setup (strengths and potential issues)
2. How well the layout supports the stated activity objectives and rules
3. Specific suggestions to improve the activity effectiveness
4. Safety considerations and risk management
5. Alternative variations or progressions for this activity
6. Tips for student engagement and maximizing learning outcomes`;

                // Add specific guidance based on activity details
                if (layout.activityDetails.name || layout.activityDetails.rules) {
                    prompt += `\n\nPay special attention to how the setup supports the specific activity rules and objectives described. Consider whether the equipment placement, student positioning, and space usage optimize the learning experience for the stated goals. If no specific sport is mentioned, analyze the layout based on the equipment and activity description provided.`;
                } else {
                    prompt += `\n\nSince no specific activity details are provided, analyze the setup based on the visible equipment and student positioning. Make suggestions that would work for the types of activities that could be conducted with the current equipment layout.`;
                }
                
                prompt += `\n\nKeep your response practical, actionable, and suitable for a PE teacher. Focus on pedagogy, safety, and student engagement. Adapt your advice to the specific sport/activity indicated by the equipment and activity description.`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.8,
                            topK: 64,
                            topP: 0.95,
                            maxOutputTokens: 4096,
                            candidateCount: 1
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const suggestions = data.candidates[0].content.parts[0].text;
                    showAISuggestions(suggestions);
                    showAIStatus('Analysis complete!', false);
                } else {
                    throw new Error('No suggestions received from AI');
                }
                
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                let errorMessage = 'Failed to analyze layout. ';
                
                if (error.message.includes('API_KEY_INVALID')) {
                    errorMessage += 'Please check your API key.';
                } else if (error.message.includes('quota')) {
                    errorMessage += 'API quota exceeded.';
                } else if (error.message.includes('blocked')) {
                    errorMessage += 'Content was blocked by safety filters.';
                } else {
                    errorMessage += `Error: ${error.message}`;
                }
                
                showAIStatus(errorMessage, true);
            } finally {
                // Reset button
                analyzeBtn.innerHTML = originalText;
                analyzeBtn.disabled = false;
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            updatePlanSelect();
            switchPhase('warmup');
            
            // Load API configuration
            loadApiConfig();
            
            // Show onboarding for first-time users
            if (!localStorage.getItem('onboardingCompleted')) {
                document.getElementById('onboardingOverlay').style.display = 'flex';
            } else {
                document.getElementById('onboardingOverlay').style.display = 'none';
            }
            
            // Add tooltip functionality
            document.querySelectorAll('[title]').forEach(element => {
                element.addEventListener('mouseenter', showTooltip);
                element.addEventListener('mouseleave', hideTooltip);
            });
            
            // Add keyboard shortcuts for modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const aiModal = document.getElementById('aiSuggestionsModal');
                    if (aiModal.classList.contains('show')) {
                        closeAISuggestionsModal();
                    }
                }
            });
            
            // Close modal when clicking outside of it
            document.getElementById('aiSuggestionsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAISuggestionsModal();
                }
            });
        });
        
        let currentTooltip = null;
        let tourStep = 0;
        const tourSteps = [
            { element: '.control-section:first-child .control-header', text: 'Start by adding equipment to your court! Click to expand.' },
            { element: '[onclick="addEquipment(\'cone\')"]', text: 'Try adding a cone - just click and it appears on the court!' },
            { element: '.badminton-court', text: 'This is your court! Drag items around to position them.' },
            { element: '[data-phase="main"]', text: 'Switch between lesson phases to organize different activities.' },
            { element: '#drawBtn', text: 'Draw movement paths to show how students should move.' }
        ];
        
        function showTooltip(e) {
            const tooltip = document.getElementById('tooltip');
            const text = e.target.getAttribute('title');
            if (!text) return;
            
            tooltip.textContent = text;
            tooltip.classList.add('show');
            
            const rect = e.target.getBoundingClientRect();
            tooltip.style.left = Math.min(rect.left + (rect.width / 2), window.innerWidth - 120) + 'px';
            tooltip.style.top = (rect.top - 40) + 'px';
            
            currentTooltip = tooltip;
        }
        
        function hideTooltip(e) {
            const tooltip = document.getElementById('tooltip');
            tooltip.classList.remove('show');
            currentTooltip = null;
        }
        
        function closeOnboarding() {
            document.getElementById('onboardingOverlay').style.display = 'none';
            localStorage.setItem('onboardingCompleted', 'true');
        }
        
        function startTour() {
            closeOnboarding();
            tourStep = 0;
            showTourStep();
        }
        
        function showTourStep() {
            if (tourStep >= tourSteps.length) {
                showSuccessMessage('Tour completed! You\'re ready to create amazing lesson plans! 🎉');
                return;
            }
            
            const step = tourSteps[tourStep];
            const element = document.querySelector(step.element);
            if (!element) {
                tourStep++;
                showTourStep();
                return;
            }
            
            element.style.position = 'relative';
            element.style.zIndex = '1001';
            element.style.boxShadow = '0 0 0 3px #3b82f6, 0 0 20px rgba(59, 130, 246, 0.3)';
            element.style.borderRadius = '8px';
            
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = step.text + '<br><small>Click anywhere to continue...</small>';
            tooltip.classList.add('show');
            
            const rect = element.getBoundingClientRect();
            tooltip.style.left = Math.min(rect.left + (rect.width / 2), window.innerWidth - 120) + 'px';
            tooltip.style.top = (rect.bottom + 10) + 'px';
            
            const nextStep = () => {
                element.style.position = '';
                element.style.zIndex = '';
                element.style.boxShadow = '';
                tooltip.classList.remove('show');
                document.removeEventListener('click', nextStep);
                tourStep++;
                setTimeout(showTourStep, 500);
            };
            
            setTimeout(() => {
                document.addEventListener('click', nextStep);
            }, 100);
        }
        
        function showSuccessMessage(message) {
            const successMsg = document.getElementById('successMessage');
            successMsg.textContent = message;
            successMsg.classList.add('show');
            
            setTimeout(() => {
                successMsg.classList.remove('show');
            }, 4000);
        }
    </script>
</body>
</html>